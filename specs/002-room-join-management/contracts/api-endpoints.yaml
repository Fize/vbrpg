openapi: 3.0.3
info:
  title: Room Join & AI Agent Management API
  version: 1.0.0
  description: |
    API endpoints for multiplayer room joining, leaving, and AI agent management.
    Extends existing VBRPG platform room functionality (feature 002-room-join-management).

servers:
  - url: http://localhost:8000/api/v1
    description: Local development server

paths:
  /rooms/{code}/join:
    post:
      summary: Join an existing game room
      description: |
        Allows a player to join an existing game room using a 6-character room code.
        Validates room capacity, status, and player eligibility before adding participant.
      operationId: joinRoom
      tags:
        - Rooms
      parameters:
        - name: code
          in: path
          required: true
          description: 6-character room code (alphanumeric, case-insensitive)
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
            example: "ABC123"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - player_id
              properties:
                player_id:
                  type: string
                  format: uuid
                  description: UUID of the player joining
                  example: "550e8400-e29b-41d4-a716-446655440000"
      responses:
        '200':
          description: Successfully joined room
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JoinRoomResponse'
        '400':
          description: Bad request (invalid code format, missing player_id)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                invalidCode:
                  value:
                    error: "INVALID_ROOM_CODE"
                    message: "Room code must be 6 alphanumeric characters"
                duplicateJoin:
                  value:
                    error: "DUPLICATE_JOIN"
                    message: "Player already in this room"
        '404':
          description: Room not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "ROOM_NOT_FOUND"
                message: "No room exists with code ABC123"
        '409':
          description: Conflict (room full or already started)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                roomFull:
                  value:
                    error: "ROOM_FULL"
                    message: "This room is at maximum capacity (4/4 players)"
                gameStarted:
                  value:
                    error: "GAME_ALREADY_STARTED"
                    message: "Cannot join room - game is already in progress"

  /rooms/{code}/participants/{player_id}:
    delete:
      summary: Leave a game room
      description: |
        Removes a player from the game room. If the player is the owner, ownership
        transfers to the next earliest-joined human player. If only AI agents remain,
        the room is dissolved.
      operationId: leaveRoom
      tags:
        - Rooms
      parameters:
        - name: code
          in: path
          required: true
          description: 6-character room code
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
        - name: player_id
          in: path
          required: true
          description: UUID of the player leaving
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Successfully left room (no content returned)
        '404':
          description: Room or player not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                roomNotFound:
                  value:
                    error: "ROOM_NOT_FOUND"
                    message: "No room exists with code ABC123"
                playerNotInRoom:
                  value:
                    error: "PLAYER_NOT_IN_ROOM"
                    message: "Player is not a participant in this room"
        '409':
          description: Cannot leave (game already in progress)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "GAME_IN_PROGRESS"
                message: "Cannot leave room while game is active"

  /rooms/{code}/ai-agents:
    post:
      summary: Add an AI agent to the room
      description: |
        Room owner manually adds an AI agent to an available slot. AI agent is
        assigned a sequential name (e.g., "AI玩家1", "AI玩家2") and appears in
        the participant list.
      operationId: addAIAgent
      tags:
        - Rooms
        - AI Agents
      parameters:
        - name: code
          in: path
          required: true
          description: 6-character room code
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - owner_player_id
              properties:
                owner_player_id:
                  type: string
                  format: uuid
                  description: UUID of the room owner making the request
      responses:
        '201':
          description: AI agent successfully added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIAgentResponse'
        '403':
          description: Forbidden (requester is not the room owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "NOT_ROOM_OWNER"
                message: "Only the room owner can add AI agents"
        '404':
          description: Room not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Room is full or game already started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                roomFull:
                  value:
                    error: "ROOM_FULL"
                    message: "Cannot add AI agent - room is at maximum capacity"
                gameStarted:
                  value:
                    error: "GAME_ALREADY_STARTED"
                    message: "Cannot modify participants after game starts"

  /rooms/{code}/ai-agents/{agent_id}:
    delete:
      summary: Remove an AI agent from the room
      description: |
        Room owner removes a previously added AI agent. Frees up the slot for
        human players or other AI agents.
      operationId: removeAIAgent
      tags:
        - Rooms
        - AI Agents
      parameters:
        - name: code
          in: path
          required: true
          description: 6-character room code
          schema:
            type: string
            pattern: '^[A-Z0-9]{6}$'
        - name: agent_id
          in: path
          required: true
          description: UUID of the AI agent to remove
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - owner_player_id
              properties:
                owner_player_id:
                  type: string
                  format: uuid
                  description: UUID of the room owner making the request
      responses:
        '204':
          description: AI agent successfully removed (no content)
        '403':
          description: Forbidden (requester is not the room owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Room or AI agent not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                agentNotFound:
                  value:
                    error: "AI_AGENT_NOT_FOUND"
                    message: "No AI agent with ID exists in this room"
        '409':
          description: Game already started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    JoinRoomResponse:
      type: object
      required:
        - room
        - participants
        - is_owner
      properties:
        room:
          $ref: '#/components/schemas/GameRoom'
        participants:
          type: array
          items:
            $ref: '#/components/schemas/Participant'
          description: List of all current participants (humans + AI)
        is_owner:
          type: boolean
          description: Whether the joining player is the room owner

    GameRoom:
      type: object
      required:
        - id
        - code
        - game_type_id
        - status
        - max_players
        - current_participant_count
        - owner_id
        - created_at
      properties:
        id:
          type: integer
          example: 42
        code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
          example: "ABC123"
        game_type_id:
          type: integer
          example: 1
        status:
          type: string
          enum: [Waiting, "In Progress", Completed]
        max_players:
          type: integer
          minimum: 2
          maximum: 8
          example: 4
        current_participant_count:
          type: integer
          minimum: 0
          example: 2
        owner_id:
          type: string
          format: uuid
          description: Player ID of the current room owner
        created_at:
          type: string
          format: date-time
        started_at:
          type: string
          format: date-time
          nullable: true
        completed_at:
          type: string
          format: date-time
          nullable: true

    Participant:
      type: object
      required:
        - id
        - player_id
        - player_name
        - participant_type
        - is_owner
        - join_timestamp
      properties:
        id:
          type: integer
          description: Participant record ID
        player_id:
          type: string
          format: uuid
        player_name:
          type: string
          example: "Alice"
        avatar_url:
          type: string
          format: uri
          nullable: true
        participant_type:
          type: string
          enum: [human, ai]
        is_owner:
          type: boolean
        join_timestamp:
          type: string
          format: date-time

    AIAgentResponse:
      type: object
      required:
        - ai_agent
        - room_code
      properties:
        ai_agent:
          $ref: '#/components/schemas/Participant'
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Machine-readable error code
          example: "ROOM_FULL"
        message:
          type: string
          description: Human-readable error message
          example: "This room is at maximum capacity (4/4 players)"
        details:
          type: object
          description: Optional additional context
          additionalProperties: true

tags:
  - name: Rooms
    description: Game room management operations
  - name: AI Agents
    description: AI agent management in game rooms
