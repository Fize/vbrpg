asyncapi: 2.6.0
info:
  title: Lobby WebSocket Events
  version: 1.0.0
  description: |
    Real-time WebSocket events for game lobby state synchronization.
    Uses Socket.IO protocol over existing python-socketio infrastructure.
    Feature: 002-room-join-management

servers:
  production:
    url: ws://localhost:8000
    protocol: socketio
    description: Local development Socket.IO server

channels:
  lobby:{room_code}:
    description: |
      Room-specific channel for lobby events. Clients join this room when
      entering a game lobby and receive all participant updates.
    parameters:
      room_code:
        description: 6-character alphanumeric room code
        schema:
          type: string
          pattern: '^[A-Z0-9]{6}$'
    subscribe:
      summary: Receive lobby state updates
      message:
        oneOf:
          - $ref: '#/components/messages/PlayerJoined'
          - $ref: '#/components/messages/PlayerLeft'
          - $ref: '#/components/messages/AIAgentAdded'
          - $ref: '#/components/messages/AIAgentRemoved'
          - $ref: '#/components/messages/OwnershipTransferred'
          - $ref: '#/components/messages/RoomDissolved'

components:
  messages:
    PlayerJoined:
      name: player_joined
      title: Player Joined Event
      summary: Broadcast when a human player joins the room
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PlayerJoinedPayload'
      examples:
        - name: Human player joins
          payload:
            room_code: "ABC123"
            player:
              id: "550e8400-e29b-41d4-a716-446655440000"
              name: "Alice"
              avatar_url: "https://example.com/avatars/alice.png"
              participant_type: "human"
              is_owner: false
              join_timestamp: "2025-11-09T10:30:00Z"
            timestamp: "2025-11-09T10:30:00Z"

    PlayerLeft:
      name: player_left
      title: Player Left Event
      summary: Broadcast when a player leaves the room
      contentType: application/json
      payload:
        $ref: '#/components/schemas/PlayerLeftPayload'
      examples:
        - name: Player leaves lobby
          payload:
            room_code: "ABC123"
            player_id: "550e8400-e29b-41d4-a716-446655440000"
            player_name: "Alice"
            timestamp: "2025-11-09T10:35:00Z"

    AIAgentAdded:
      name: ai_agent_added
      title: AI Agent Added Event
      summary: Broadcast when room owner manually adds an AI agent
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AIAgentAddedPayload'
      examples:
        - name: Owner adds first AI agent
          payload:
            room_code: "ABC123"
            ai_agent:
              id: "a1b2c3d4-e5f6-4g7h-8i9j-0k1l2m3n4o5p"
              name: "AI玩家1"
              participant_type: "ai"
              is_owner: false
              join_timestamp: "2025-11-09T10:32:00Z"
            added_by: "550e8400-e29b-41d4-a716-446655440000"
            added_by_name: "Bob"
            timestamp: "2025-11-09T10:32:00Z"

    AIAgentRemoved:
      name: ai_agent_removed
      title: AI Agent Removed Event
      summary: Broadcast when room owner removes an AI agent
      contentType: application/json
      payload:
        $ref: '#/components/schemas/AIAgentRemovedPayload'
      examples:
        - name: Owner removes AI agent
          payload:
            room_code: "ABC123"
            ai_agent_id: "a1b2c3d4-e5f6-4g7h-8i9j-0k1l2m3n4o5p"
            ai_agent_name: "AI玩家1"
            removed_by: "550e8400-e29b-41d4-a716-446655440000"
            removed_by_name: "Bob"
            timestamp: "2025-11-09T10:33:00Z"

    OwnershipTransferred:
      name: ownership_transferred
      title: Ownership Transferred Event
      summary: Broadcast when room ownership changes (owner leaves or manual transfer)
      contentType: application/json
      payload:
        $ref: '#/components/schemas/OwnershipTransferredPayload'
      examples:
        - name: Owner leaves, ownership transfers
          payload:
            room_code: "ABC123"
            previous_owner_id: "550e8400-e29b-41d4-a716-446655440000"
            previous_owner_name: "Bob"
            new_owner_id: "660e9500-f30c-52e5-b827-557766551111"
            new_owner_name: "Charlie"
            reason: "owner_left"
            timestamp: "2025-11-09T10:36:00Z"

    RoomDissolved:
      name: room_dissolved
      title: Room Dissolved Event
      summary: Broadcast when room is dissolved (owner leaves with only AI remaining)
      contentType: application/json
      payload:
        $ref: '#/components/schemas/RoomDissolvedPayload'
      examples:
        - name: Last human leaves AI-only room
          payload:
            room_code: "ABC123"
            reason: "no_human_players_remaining"
            timestamp: "2025-11-09T10:37:00Z"

  schemas:
    PlayerJoinedPayload:
      type: object
      required:
        - room_code
        - player
        - timestamp
      properties:
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
          description: Room code where player joined
        player:
          type: object
          required:
            - id
            - name
            - participant_type
            - is_owner
            - join_timestamp
          properties:
            id:
              type: string
              format: uuid
              description: Player UUID
            name:
              type: string
              description: Player display name
            avatar_url:
              type: string
              format: uri
              nullable: true
              description: Player avatar image URL
            participant_type:
              type: string
              enum: [human, ai]
            is_owner:
              type: boolean
              description: Whether this player is the room owner
            join_timestamp:
              type: string
              format: date-time
              description: When player joined (ISO 8601)
        timestamp:
          type: string
          format: date-time
          description: Server event timestamp (ISO 8601)

    PlayerLeftPayload:
      type: object
      required:
        - room_code
        - player_id
        - player_name
        - timestamp
      properties:
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
        player_id:
          type: string
          format: uuid
          description: UUID of player who left
        player_name:
          type: string
          description: Name of player who left (for UI notifications)
        timestamp:
          type: string
          format: date-time

    AIAgentAddedPayload:
      type: object
      required:
        - room_code
        - ai_agent
        - added_by
        - added_by_name
        - timestamp
      properties:
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
        ai_agent:
          type: object
          required:
            - id
            - name
            - participant_type
            - is_owner
            - join_timestamp
          properties:
            id:
              type: string
              format: uuid
              description: Generated AI agent UUID
            name:
              type: string
              description: Auto-generated AI name (e.g., "AI玩家1")
            participant_type:
              type: string
              enum: [ai]
              const: ai
            is_owner:
              type: boolean
              const: false
              description: AI agents are never owners
            join_timestamp:
              type: string
              format: date-time
        added_by:
          type: string
          format: uuid
          description: Owner player ID who added the AI
        added_by_name:
          type: string
          description: Owner name (for UI notifications)
        timestamp:
          type: string
          format: date-time

    AIAgentRemovedPayload:
      type: object
      required:
        - room_code
        - ai_agent_id
        - ai_agent_name
        - removed_by
        - removed_by_name
        - timestamp
      properties:
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
        ai_agent_id:
          type: string
          format: uuid
          description: UUID of removed AI agent
        ai_agent_name:
          type: string
          description: AI agent name (for UI notifications)
        removed_by:
          type: string
          format: uuid
          description: Owner player ID who removed the AI
        removed_by_name:
          type: string
          description: Owner name (for UI notifications)
        timestamp:
          type: string
          format: date-time

    OwnershipTransferredPayload:
      type: object
      required:
        - room_code
        - previous_owner_id
        - previous_owner_name
        - new_owner_id
        - new_owner_name
        - reason
        - timestamp
      properties:
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
        previous_owner_id:
          type: string
          format: uuid
          description: UUID of previous owner
        previous_owner_name:
          type: string
          description: Previous owner name
        new_owner_id:
          type: string
          format: uuid
          description: UUID of new owner
        new_owner_name:
          type: string
          description: New owner name
        reason:
          type: string
          enum: [owner_left, manual_transfer]
          description: Why ownership transferred
        timestamp:
          type: string
          format: date-time

    RoomDissolvedPayload:
      type: object
      required:
        - room_code
        - reason
        - timestamp
      properties:
        room_code:
          type: string
          pattern: '^[A-Z0-9]{6}$'
        reason:
          type: string
          enum: [no_human_players_remaining, timeout, manual_deletion]
          description: Why the room was dissolved
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    socketio:
      type: userPassword
      description: |
        Players authenticate via HTTP first, receive a session token,
        then include it in Socket.IO connection handshake.
