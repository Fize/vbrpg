asyncapi: 3.0.0
info:
  title: VBRPG Platform WebSocket API - Frontend Missing Features
  version: 1.0.0
  description: |
    Real-time event communication for game state synchronization, player actions, and AI behaviors.
    Uses Socket.IO protocol for bidirectional messaging.

servers:
  development:
    host: localhost:8000
    protocol: socketio
    description: Local development WebSocket server
    security:
      - type: apiKey
        description: Session cookie authentication

channels:
  lobby:
    address: /
    messages:
      lobby_joined:
        $ref: '#/components/messages/LobbyJoined'
      lobby_left:
        $ref: '#/components/messages/LobbyLeft'
      player_joined:
        $ref: '#/components/messages/PlayerJoined'
      player_left:
        $ref: '#/components/messages/PlayerLeft'

  game:
    address: /
    messages:
      game_started:
        $ref: '#/components/messages/GameStarted'
      game_state_update:
        $ref: '#/components/messages/GameStateUpdate'
      turn_changed:
        $ref: '#/components/messages/TurnChanged'
      game_action:
        $ref: '#/components/messages/GameAction'
      game_ended:
        $ref: '#/components/messages/GameEnded'

  ai:
    address: /
    messages:
      ai_thinking:
        $ref: '#/components/messages/AIThinking'
      ai_action:
        $ref: '#/components/messages/AIAction'
      ai_timeout:
        $ref: '#/components/messages/AITimeout'

  reconnection:
    address: /
    messages:
      reconnect:
        $ref: '#/components/messages/Reconnect'
      rejoin_room:
        $ref: '#/components/messages/RejoinRoom'

operations:
  joinLobby:
    action: send
    channel:
      $ref: '#/channels/lobby'
    messages:
      - $ref: '#/components/messages/LobbyJoined'
    description: |
      Emitted by server when client successfully connects to lobby.
      Confirms WebSocket connection established (FR-030).

  leaveLobby:
    action: send
    channel:
      $ref: '#/channels/lobby'
    messages:
      - $ref: '#/components/messages/LobbyLeft'
    description: |
      Emitted by server when client disconnects from lobby.
      Confirms graceful disconnect (FR-030).

  playerJoinedRoom:
    action: send
    channel:
      $ref: '#/channels/lobby'
    messages:
      - $ref: '#/components/messages/PlayerJoined'
    description: |
      Broadcasted to all players in room when new player joins.
      Updates participant list in UI.

  playerLeftRoom:
    action: send
    channel:
      $ref: '#/channels/lobby'
    messages:
      - $ref: '#/components/messages/PlayerLeft'
    description: |
      Broadcasted to all players in room when player leaves.
      Updates participant list in UI.

  gameStart:
    action: send
    channel:
      $ref: '#/channels/game'
    messages:
      - $ref: '#/components/messages/GameStarted'
    description: |
      Sent to all players when game begins.
      Includes initial game state, suspects, locations (FR-038, FR-039, FR-040).

  gameStateSync:
    action: send
    channel:
      $ref: '#/channels/game'
    messages:
      - $ref: '#/components/messages/GameStateUpdate'
    description: |
      Sent to all players after any state change.
      Full snapshot on reconnect, delta updates during gameplay (FR-031, FR-036).

  turnChange:
    action: send
    channel:
      $ref: '#/channels/game'
    messages:
      - $ref: '#/components/messages/TurnChanged'
    description: |
      Sent to all players when turn advances.
      Triggers timer reset, highlights current player (FR-032, FR-023).

  submitGameAction:
    action: receive
    channel:
      $ref: '#/channels/game'
    messages:
      - $ref: '#/components/messages/GameAction'
    description: |
      Sent by client to submit player action (investigate, interrogate, accuse).
      Backend validates and broadcasts state update (FR-016, FR-018, FR-020).

  gameEnd:
    action: send
    channel:
      $ref: '#/channels/game'
    messages:
      - $ref: '#/components/messages/GameEnded'
    description: |
      Sent to all players when game concludes.
      Includes winner, case solution, player stats (FR-035, FR-048).

  aiThinkingStart:
    action: send
    channel:
      $ref: '#/channels/ai'
    messages:
      - $ref: '#/components/messages/AIThinking'
    description: |
      Sent to all players when AI player begins processing action.
      Triggers loading animation in UI (FR-033).

  aiActionComplete:
    action: send
    channel:
      $ref: '#/channels/ai'
    messages:
      - $ref: '#/components/messages/AIAction'
    description: |
      Sent to all players when AI action completes.
      Shows AI decision, triggers state update (FR-034).

  aiTimeout:
    action: send
    channel:
      $ref: '#/channels/ai'
    messages:
      - $ref: '#/components/messages/AITimeout'
    description: |
      Sent when AI LLM service exceeds 10s timeout.
      Notifies players, triggers fallback behavior (Constitution §V).

  clientReconnect:
    action: send
    channel:
      $ref: '#/channels/reconnection'
    messages:
      - $ref: '#/components/messages/Reconnect'
    description: |
      Sent by server when client reconnects after disconnect.
      Triggers rejoin flow if within 5-minute grace period (FR-036).

  rejoinRequest:
    action: receive
    channel:
      $ref: '#/channels/reconnection'
    messages:
      - $ref: '#/components/messages/RejoinRoom'
    description: |
      Sent by client to rejoin room after reconnection.
      Backend responds with full game state snapshot.

components:
  messages:
    LobbyJoined:
      name: lobby_joined
      title: Lobby Joined Confirmation
      payload:
        type: object
        required:
          - player_id
          - timestamp
        properties:
          player_id:
            type: integer
            description: ID of connected player
            example: 1
          timestamp:
            type: integer
            description: Server timestamp (Unix epoch ms)
            example: 1699800000000

    LobbyLeft:
      name: lobby_left
      title: Lobby Left Confirmation
      payload:
        type: object
        required:
          - player_id
          - timestamp
        properties:
          player_id:
            type: integer
            description: ID of disconnected player
            example: 1
          timestamp:
            type: integer
            description: Server timestamp (Unix epoch ms)
            example: 1699800000000

    PlayerJoined:
      name: player_joined
      title: Player Joined Room
      payload:
        type: object
        required:
          - room_code
          - player_id
          - username
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          player_id:
            type: integer
            description: Joined player ID
            example: 2
          username:
            type: string
            description: Joined player display name
            example: "玩家456"

    PlayerLeft:
      name: player_left
      title: Player Left Room
      payload:
        type: object
        required:
          - room_code
          - player_id
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          player_id:
            type: integer
            description: Departed player ID
            example: 2

    GameStarted:
      name: game_started
      title: Game Started
      payload:
        type: object
        required:
          - room_code
          - game_state
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          game_state:
            $ref: '#/components/schemas/GameState'

    GameStateUpdate:
      name: game_state_update
      title: Game State Update
      payload:
        type: object
        required:
          - room_code
          - game_state
          - update_type
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          game_state:
            $ref: '#/components/schemas/GameState'
          update_type:
            type: string
            enum:
              - full_snapshot
              - delta
            description: Type of update (full on reconnect, delta during play)
            example: "delta"

    TurnChanged:
      name: turn_changed
      title: Turn Changed
      payload:
        type: object
        required:
          - room_code
          - current_player_id
          - turn_number
          - time_limit_seconds
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          current_player_id:
            type: integer
            description: Player whose turn it is
            example: 1
          turn_number:
            type: integer
            description: Sequential turn counter
            example: 5
          time_limit_seconds:
            type: integer
            description: Seconds allowed for this turn
            example: 60

    GameAction:
      name: game_action
      title: Game Action Submission
      payload:
        type: object
        required:
          - room_code
          - action_type
          - timestamp
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          action_type:
            type: string
            enum:
              - investigate
              - interrogate
              - accuse
              - pass
            description: Type of action
            example: "investigate"
          target:
            type: string
            description: Target location or suspect ID (required for investigate/interrogate/accuse)
            example: "library"
          parameters:
            type: object
            description: Action-specific data (e.g., evidence for accusation)
            example:
              evidence:
                - "clue_bloodstain"
                - "clue_fingerprint"
          timestamp:
            type: integer
            description: Client submission time (Unix epoch ms)
            example: 1699800000000

    GameEnded:
      name: game_ended
      title: Game Ended
      payload:
        type: object
        required:
          - room_code
          - winner_id
          - case_solution
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          winner_id:
            type: integer
            description: Winning player ID (null if no winner)
            example: 1
          case_solution:
            type: object
            description: Case truth reveal
            properties:
              guilty_suspect_id:
                type: string
                example: "suspect_butler"
              motive:
                type: string
                example: "财务纠纷"
              method:
                type: string
                example: "毒药"
              explanation:
                type: string
                example: "管家因遗产分配不公而下毒..."
          player_stats:
            type: array
            description: Final statistics for all players
            items:
              type: object
              properties:
                player_id:
                  type: integer
                  example: 1
                actions_taken:
                  type: integer
                  example: 12
                clues_found:
                  type: integer
                  example: 8
                correct_accusations:
                  type: integer
                  example: 1

    AIThinking:
      name: ai_thinking
      title: AI Thinking Started
      payload:
        type: object
        required:
          - room_code
          - player_id
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          player_id:
            type: integer
            description: AI player ID
            example: 99

    AIAction:
      name: ai_action
      title: AI Action Completed
      payload:
        type: object
        required:
          - room_code
          - player_id
          - action
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          player_id:
            type: integer
            description: AI player ID
            example: 99
          action:
            $ref: '#/components/schemas/GameAction'
          reasoning:
            type: string
            description: AI's decision explanation (optional)
            example: "我选择调查图书馆因为那里可能有关键证据"

    AITimeout:
      name: ai_timeout
      title: AI LLM Timeout
      payload:
        type: object
        required:
          - room_code
          - player_id
          - fallback_action
        properties:
          room_code:
            type: string
            description: 6-character room code
            example: "ABC123"
          player_id:
            type: integer
            description: AI player ID
            example: 99
          fallback_action:
            type: string
            enum:
              - pass
              - random_investigate
            description: Default action used due to timeout
            example: "pass"

    Reconnect:
      name: reconnect
      title: Client Reconnected
      payload:
        type: object
        required:
          - player_id
          - timestamp
        properties:
          player_id:
            type: integer
            description: Reconnected player ID
            example: 1
          timestamp:
            type: integer
            description: Reconnection time (Unix epoch ms)
            example: 1699800000000

    RejoinRoom:
      name: rejoin_room
      title: Rejoin Room Request
      payload:
        type: object
        required:
          - room_code
          - player_id
        properties:
          room_code:
            type: string
            description: 6-character room code to rejoin
            example: "ABC123"
          player_id:
            type: integer
            description: Player requesting rejoin
            example: 1

  schemas:
    GameState:
      type: object
      required:
        - current_turn
        - turn_number
        - suspects
        - locations
        - players
      properties:
        current_turn:
          type: integer
          description: ID of player whose turn it is
          example: 1
        turn_number:
          type: integer
          description: Sequential turn counter
          example: 5
        suspects:
          type: array
          description: All suspects in game
          items:
            type: object
            properties:
              id:
                type: string
                example: "suspect_butler"
              name:
                type: string
                example: "管家 李明"
              description:
                type: string
                example: "在宅邸工作10年的管家"
              avatar_url:
                type: string
                example: "https://example.com/avatars/butler.png"
              available_topics:
                type: array
                items:
                  type: string
                example:
                  - "alibi"
                  - "motive"
                  - "relationship"
        locations:
          type: array
          description: All investigatable locations
          items:
            type: object
            properties:
              id:
                type: string
                example: "library"
              name:
                type: string
                example: "图书馆"
              description:
                type: string
                example: "摆满古书的房间"
              is_investigated:
                type: boolean
                description: Whether any player has investigated this location
                example: false
        players:
          type: array
          description: Player-specific game state (investigations, clues)
          items:
            type: object
            properties:
              player_id:
                type: integer
                example: 1
              visited_locations:
                type: array
                items:
                  type: string
                example:
                  - "library"
                  - "kitchen"
              discovered_clues:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      example: "clue_bloodstain"
                    description:
                      type: string
                      example: "地板上的血迹"
                    location:
                      type: string
                      example: "library"
                    importance:
                      type: integer
                      minimum: 1
                      maximum: 5
                      example: 4
                    discovered_at:
                      type: string
                      format: date-time
                      example: "2025-11-12T12:30:00Z"
              interrogation_history:
                type: array
                items:
                  type: object
                  properties:
                    suspect_id:
                      type: string
                      example: "suspect_butler"
                    topic:
                      type: string
                      example: "alibi"
                    answer:
                      type: string
                      example: "我当时在厨房准备晚餐"
                    timestamp:
                      type: string
                      format: date-time
                      example: "2025-11-12T12:45:00Z"
              accusations_remaining:
                type: integer
                description: Number of accusation attempts left
                example: 2

    GameAction:
      type: object
      required:
        - action_type
        - timestamp
      properties:
        action_type:
          type: string
          enum:
            - investigate
            - interrogate
            - accuse
            - pass
          description: Type of action
        target:
          type: string
          description: Target location or suspect ID
        parameters:
          type: object
          description: Action-specific parameters
        timestamp:
          type: integer
          description: Action timestamp (Unix epoch ms)
