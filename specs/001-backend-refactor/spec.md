# Feature Specification: Backend Single User Refactor

**Feature Branch**: `001-backend-refactor`  
**Created**: 2025-11-26  
**Status**: Draft  
**Input**: User description: "我希望完全重构后端服务，游戏中没有多用户的参与，只有单用户进行对局体验或作为旁观者旁观AI进行游戏，清理无用的API和代码。无需兼容性处理，本项目还在本地开发阶段"

## Clarifications

### Session 2025-11-26

- Q: 用户身份识别 - 如何处理用户身份，是保留简化的用户模型还是完全移除用户概念？ → A: 简化到本地会话标识符，不存储持久用户身份
- Q: AI对手数量数量限制 - 应该限制用户可添加的AI对手数量吗？ → A: 根据游戏类型预设不同的AI数量限制
- Q: 数据持久化策略 - 如何处理游戏数据的存储？ → A: 仅保留本地游戏历史，短期存储（30天）
- Q: API重构范围 - 如何处理现有API接口？ → A: 创建全新的简化的API接口，符合REST风格，允许破坏性更改
- Q: 前端与后端的通信方式 - 应该使用哪些通信协议？ → A: 保留WebSocket用于实时游戏更新，REST API用于其他操作

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 单用户游戏体验 (Priority: P1)

用户能够独自创建游戏房间，与AI对手进行游戏，无需其他真人玩家参与。

**Why this priority**: 这是核心功能，实现用户的基本游戏需求，为AI对弈提供基础。

**Independent Test**: 可通过创建房间、添加AI对手、开始游戏并验证游戏流程来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户启动应用，**When** 用户选择创建新游戏，**Then** 系统创建一个单人游戏房间，用户可以作为唯一玩家
2. **Given** 用户在游戏房间中，**When** 用户添加AI对手，**Then** AI玩家加入房间，用户可以开始游戏
3. **Given** 游戏进行中，**When** 用户离开游戏，**Then** 游戏会自动暂停或结束，不需要等待其他玩家

---

### User Story 2 - AI对弈旁观模式 (Priority: P2)

用户可以选择作为旁观者观看AI之间的对弈，无需参与游戏操作。

**Why this priority**: 提供学习娱乐功能，让用户观察AI策略，增强用户体验。

**Independent Test**: 可通过创建AI对弈房间并设置为旁观模式来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户选择旁观模式，**When** 用户启动AI对弈，**Then** 系统创建仅包含AI玩家的游戏房间
2. **Given** AI对弈进行中，**When** 用户作为旁观者观看，**Then** 用户能看到完整的游戏状态和AI决策过程
3. **Given** AI对弈结束，**When** 结果生成，**Then** 旁观者可以看到游戏结果和统计数据

---

### User Story 3 - 简化房间管理 (Priority: P2)

简化的房间创建和管理流程，专注于单用户游戏体验，移除多用户相关的复杂功能。

**Why this priority**: 减少用户操作复杂度，提升单用户游戏体验。

**Independent Test**: 可通过测试房间创建流程和简化的管理选项来独立测试。

**Acceptance Scenarios**:

1. **Given** 用户创建新游戏，**When** 用户选择游戏类型，**Then** 系统自动配置适合单用户的游戏设置
2. **Given** 游戏房间创建后，**When** 用户查看房间信息，**Then** 界面只显示单用户相关的管理选项
3. **Given** 游戏结束，**When** 用户选择新游戏，**Then** 系统可以快速重置或创建新房间

---

### Edge Cases

- 游戏过程中AI对手崩溃或失去响应的处理方式
- 单用户同时开启多个游戏会话的限制
- 旁观模式下用户与AI交互的限制
- WebSocket连接断开时的游戏状态恢复机制

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持单用户创建和管理游戏房间，无需等待其他玩家
- **FR-002**: 系统必须支持用户添加多个AI对手到游戏房间，根据游戏类型预设不同的AI数量限制
- **FR-003**: 系统必须提供旁观模式，允许用户观看AI之间的对弈
- **FR-004**: 系统必须创建全新的简化API接口，符合REST风格，允许破坏性更改
- **FR-005**: 系统必须移除所有多用户认证、注册和登录功能
- **FR-006**: 系统必须移除房间等待和邀请其他玩家的功能
- **FR-007**: 系统必须简化游戏流程，自动处理单人游戏所需的条件
- **FR-008**: 系统必须保留游戏核心逻辑和AI智能体功能
- **FR-008**: 系统必须保留本地游戏历史记录和统计数据功能，短期存储（30天），针对单用户优化

### Key Entities *(include if feature involves data)*

- **GameRoom**: 简化后的游戏房间，专为单用户体验设计，移除多用户相关的复杂管理
- **Player**: 简化为本地会话标识符，不存储持久用户身份，移除所有认证相关字段
- **AIAgent**: 保留并优化AI实体，作为游戏的主要对手
- **GameSession**: 保留但调整为本地游戏会话记录，短期存储（30天），适配单用户场景
- **GameState**: 保留游戏状态管理，但简化为单用户和AI之间的交互

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在30秒内创建新的单人游戏并开始游戏
- **SC-002**: 系统响应时间提高50%，移除多用户管理带来的性能开销
- **SC-003**: 代码行数减少30%以上，清理不必要的多用户相关代码
- **SC-004**: API端点数量减少至少40%，仅保留单用户游戏所需的接口
- **SC-005**: 单用户可以流畅完成至少10种不同类型的AI对弈游戏
- **SC-006**: 旁观模式下用户可以无延迟观看完整的AI对弈过程
- **SC-007**: 游戏启动时间减少到5秒以内，无需等待其他玩家加入