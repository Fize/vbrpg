# 单人玩家参与狼人杀游戏 - 需求规格文档

## 1. 项目概述

### 1.1 项目背景
- **项目起源**：当前狼人杀游戏主要支持纯AI对战或观众模式，缺乏真正的玩家参与体验。玩家无法以角色身份融入游戏，与AI玩家进行实质性互动。
- **核心问题**：
  - 玩家无法选择并扮演游戏中的角色
  - 游戏讨论和发言阶段没有处理人类玩家的输入机制
  - AI玩家无法获取和理解人类玩家的发言内容
  - 主持人无法正确识别和处理人类玩家的发言
  - 玩家在夜间行动阶段缺乏交互界面
  - 玩家在投票阶段缺乏投票交互方式
- **项目愿景**：让单人玩家能够完整参与狼人杀游戏的全流程，扮演任意角色，与AI玩家进行真实互动，体验完整的狼人杀社交推理乐趣

### 1.2 业务价值
- **业务目标**：实现单人玩家参与狼人杀游戏的完整功能，使玩家成为游戏中真正的参与者而非旁观者
- **预期价值**：
  - 大幅提升游戏的可玩性和沉浸感
  - 让玩家体验真正的社交推理游戏乐趣
  - 为后续多人游戏模式奠定基础
- **成功指标**：
  - 玩家能够成功选择并扮演任意角色完成一局游戏
  - 玩家发言能被AI玩家正确接收和理解
  - 主持人能正确识别玩家发言并推进游戏进程
  - 玩家能顺利完成夜间行动和投票操作

### 1.3 项目范围
- **包含范围**：
  - 玩家角色选择功能（自选/随机）
  - 玩家发言输入与处理
  - AI玩家获取人类玩家发言的机制
  - 主持人识别玩家发言的机制
  - 玩家夜间行动交互界面
  - 玩家投票交互界面
- **排除范围**：
  - 多人玩家同时参与（本需求仅支持单人玩家）
  - 游戏规则或角色技能的变更
  - 新角色类型的添加
- **交付物**：
  - 完整的单人玩家参与狼人杀游戏功能

## 2. 利益相关者分析

### 2.1 用户群体
- **主要用户**：希望以玩家身份参与狼人杀游戏的单人玩家
- **次要用户**：希望练习狼人杀游戏技巧的玩家
- **用户画像**：喜欢社交推理游戏的玩家，希望在无法组局的情况下也能体验狼人杀的乐趣，通过与AI对战来磨练策略和推理能力

### 2.2 使用场景
- **主要场景**：玩家选择一个角色（如预言家、狼人等），与AI玩家一起进行狼人杀游戏，参与白天讨论、发言、投票，以及夜间的角色行动
- **次要场景**：玩家选择随机角色，体验不同角色的游戏策略
- **边界场景**：
  - 玩家在发言阶段长时间未输入时的处理
  - 玩家在投票/行动阶段未做选择时的处理
  - 玩家角色在游戏中被淘汰后的观战模式

## 3. 功能需求

### 3.1 核心功能领域

#### P0 - 必须实现的核心功能

**功能领域1：玩家角色选择**
- **业务价值**：让玩家能够选择心仪的角色参与游戏，提升游戏体验的自主性和多样性
- **关键用户故事**：
  作为一名狼人杀玩家，我希望在游戏开始前能够选择我想扮演的角色（如村民、狼人、预言家、女巫、猎人），或者让系统随机分配一个角色给我，这样我可以体验不同角色的游戏乐趣。
- **验收标准**：
  - 游戏开始前显示角色选择界面
  - 提供所有可选角色列表供玩家选择
  - 每个角色显示角色名称、技能描述和阵营信息
  - 提供"随机分配"选项，让系统随机选择一个角色
  - 玩家确认选择后，系统根据选择分配角色
  - 玩家选择的角色从AI角色池中移除，确保无重复
  - 玩家的座位号由系统随机分配（影响发言顺序）
  - 如果玩家选择狼人角色，仅在夜间行动阶段显示狼人同伴身份

**功能领域2：玩家发言输入与处理**
- **业务价值**：让玩家能够在讨论和发言阶段表达自己的观点，真正参与游戏互动
- **关键用户故事**：
  作为一名狼人杀玩家，当游戏进入讨论或发言阶段且轮到我发言时，我希望能够通过输入框发表我的发言，并让其他AI玩家和主持人能够接收到我的发言内容。
- **验收标准**：
  - 当轮到玩家发言时，发言输入框自动激活并高亮提示
  - 提供根据游戏状态动态生成的预设发言选项：
    - 根据存活玩家编号生成"我怀疑X号玩家"选项
    - 根据当前讨论焦点生成相关选项
    - 根据玩家角色生成角色相关选项（如预言家可选"我查验了X号"）
  - 玩家可以自由输入发言内容
  - 发言提交后立即显示在游戏日志中
  - 非发言时段输入框显示禁用状态，并提示当前状态
  - 等待玩家发言时定期显示提醒
  - 超时处理：若玩家超过5分钟未操作，由AI自动代替玩家进行发言/行动

**功能领域3：AI玩家获取人类玩家发言**
- **业务价值**：确保AI玩家能够像获取其他AI发言一样获取人类玩家的发言，使游戏逻辑完整一致
- **关键用户故事**：
  作为游戏系统，当人类玩家发言后，AI玩家需要能够获取该发言内容，并在后续的推理和决策中考虑玩家的发言，这样游戏才能正常进行。
- **验收标准**：
  - 玩家发言后，发言内容被正确记录到游戏状态中
  - AI玩家在进行决策时能够获取到玩家的历史发言
  - 玩家发言与AI发言在数据结构上保持一致
  - AI玩家能够正确区分不同玩家（包括人类玩家）的发言
  - 玩家发言能影响AI玩家的投票和行动决策

**功能领域4：主持人识别玩家发言**
- **业务价值**：确保主持人能正确处理玩家发言，推进游戏流程
- **关键用户故事**：
  作为游戏主持人（系统），当人类玩家完成发言后，我需要能够正确识别这是玩家的发言，并据此推进游戏进程到下一环节（如下一位玩家发言或进入投票阶段）。
- **验收标准**：
  - 主持人能区分人类玩家和AI玩家
  - 玩家发言提交后，主持人自动推进游戏进程
  - 主持人在等待玩家发言时不会跳过玩家
  - 主持人正确记录玩家发言到游戏历史
  - 主持人在总结发言时能正确引用玩家的发言内容

**功能领域5：玩家夜间行动交互**
- **业务价值**：让扮演特殊角色的玩家能够在夜间执行其角色技能，完整体验角色能力
- **关键用户故事**：
  作为一名扮演特殊角色（狼人/预言家/女巫/猎人）的玩家，当夜间轮到我行动时，我希望能够通过界面选择我的行动目标，这样我可以使用我的角色技能。
- **验收标准**：
  - **狼人玩家**：
    - 显示存活玩家列表（包含玩家自身及其他所有存活玩家，方便选择自刀或其他目标）
    - 提供预设选项与自由选择用于目标选择，明确支持玩家选择"自刀"（选择自身为击杀目标）
    - 若存在多名狼人，提供狼人专属私密讨论面板（狼队聊天）：
      - 私密讨论面板仅对狼人阵营可见（包含人类玩家和AI狼）
      - 面板提供输入框供玩家与AI狼实时讨论、建议和投票（支持自由文本与预设快捷选项）
      - AI狼能获取并参考玩家在私密讨论中的发言内容，以参与决策
    - 夜间讨论结束后，狼队（人类+AI）应达成最终击杀目标并提交：若玩家选择自刀则按玩家意愿记录并执行
    - 主持人负责收集并确认狼队最终选择，记录行动到游戏历史并推进后续流程
    - 超时处理：若玩家或狼队成员在设定超时（参见超时规则）内未就目标达成共识，AI将根据默认策略代替缺席玩家完成选择
  - **预言家玩家**：
    - 显示存活玩家列表（排除自己）
    - 选择查验目标后显示查验结果（好人/狼人）
  - **女巫玩家**：
    - 显示当晚被杀玩家信息（如有）
    - 提供使用解药/毒药的选项
    - 解药：选择是否救人
    - 毒药：选择毒杀目标或不使用
    - 显示剩余药品数量
  - **猎人玩家**：
    - 被淘汰时显示存活玩家列表
    - 选择开枪带走的目标或选择不开枪
  - **村民玩家**：夜间无行动，显示等待提示
  - 所有夜间行动有清晰的操作提示
  - 行动选择支持取消和重选（在确认前）

**功能领域6：玩家遗言发表**
- **业务价值**：让被淘汰的玩家有机会发表遗言，完善游戏体验和策略表达
- **关键用户故事**：
  作为一名被投票出局的玩家，我希望能够发表遗言，向其他玩家传递信息或表达观点。
- **验收标准**：
  - 玩家被投票出局后，显示遗言输入界面
  - 提供遗言输入框供玩家自由输入
  - 提供预设遗言选项供快速选择
  - 遗言提交后显示在游戏日志中
  - AI玩家能够获取并参考玩家的遗言内容
  - 遗言发表有时间限制（建议60秒），超时则跳过
  - 被狼人夜间击杀的玩家无遗言机会（根据标准规则）

**功能领域7：玩家投票交互**
- **业务价值**：让玩家能够在投票阶段行使投票权，参与游戏的关键决策
- **关键用户故事**：
  作为一名狼人杀玩家，当游戏进入投票阶段时，我希望能够选择我要投票的目标玩家或选择弃权，并看到投票结果。
- **验收标准**：
  - 投票阶段显示所有存活玩家列表作为投票选项
  - 每个选项显示玩家编号和角色名称（如已暴露）
  - 提供"弃权"选项
  - 玩家选择投票目标后需要确认
  - 投票提交后不可更改
  - 显示投票倒计时（可选，建议60秒）
  - 所有玩家投票完成后显示投票结果
  - 平票时根据游戏规则处理（显示平票重投或无人出局）

#### P1 - 重要功能

**功能领域8：玩家被淘汰后的观战模式**
- **业务价值**：让被淘汰的玩家仍能继续观看游戏进程，保持游戏参与感
- **关键用户故事**：
  作为一名被淘汰的玩家，我希望能够继续观看游戏的进行，看到其他玩家的发言和行动结果，直到游戏结束。
- **验收标准**：
  - 玩家被淘汰后自动切换到观战模式
  - 观战模式下隐藏发言输入框和行动面板
  - 观战模式下可以看到所有公开信息
  - 可选：观战模式下显示所有角色身份（上帝视角）
  - 游戏结束后显示完整的游戏复盘信息

### 3.2 功能依赖关系
- **前置依赖**：
  - 玩家角色选择是所有其他功能的前置条件
  - 玩家发言输入依赖于游戏阶段判断
  - AI获取玩家发言依赖于发言数据结构
- **后置影响**：
  - 玩家参与功能影响整体游戏流程控制
  - 主持人需要区分处理AI和人类玩家
- **实现顺序**：
  1. 玩家角色选择
  2. 主持人识别玩家发言
  3. 玩家发言输入与处理
  4. AI玩家获取人类玩家发言
  5. 玩家夜间行动交互
  6. 玩家遗言发表
  7. 玩家投票交互
  8. 玩家被淘汰后的观战模式

## 4. 非功能性需求

### 4.1 用户体验需求
- **易用性**：角色选择、发言输入、投票操作都应简单直观
- **学习成本**：界面交互符合直觉，无需额外学习
- **界面偏好**：与现有游戏界面风格保持一致

### 4.2 性能需求
- **响应时间**：
  - 发言提交响应时间 < 500ms
  - 投票提交响应时间 < 500ms
  - 夜间行动提交响应时间 < 500ms
- **并发能力**：支持单人玩家流畅游戏

## 5. 风险评估

### 5.1 业务风险
- **中等风险项**：
  - 玩家发言时机判断可能不够精确
  - AI理解玩家自由发言可能存在偏差
- **低风险项**：
  - 预设选项可能无法覆盖所有玩家需求

### 5.2 用户接受度风险
- **用户适应性**：功能设计符合用户预期，风险低
- **学习成本**：交互方式简单，无额外学习成本

### 5.3 风险应对策略
- **缓解计划**：
  - 发言输入框显示明确的状态提示
  - 提供丰富的预设选项同时保留自由输入
  - AI决策时对玩家发言做适当的容错处理

## 6. 成功标准

### 6.1 业务成功指标
- **核心指标**：
  - 玩家能够选择任意角色并完成一局完整游戏
  - 玩家发言能被AI正确接收和理解
  - 游戏流程不因玩家参与而中断

### 6.2 用户满意度指标
- **满意度目标**：功能使用流畅，交互自然
- **使用率目标**：所有核心功能100%可用

### 6.3 项目完成标准
- **功能完整**：
  - 8个功能领域全部实现
  - 所有验收标准通过验证
- **质量达标**：
  - 无阻塞性或严重bug
  - 响应时间满足性能需求
- **用户验收**：
  - 玩家能够扮演任意角色完成完整游戏
  - 发言、投票、夜间行动功能正常

## 7. 依赖关系

### 7.1 内部依赖
- **技术依赖**：
  - 现有狼人杀游戏引擎（werewolf_engine.py）
  - AI代理系统（ai_agents/）
  - 主持人模块（ai_agents/host/）
  - WebSocket实时通信机制
  - 现有游戏界面组件

### 7.2 外部依赖
- **第三方服务**：
  - LLM服务用于AI决策和发言生成

## 8. 优先级排序
- **功能优先级**：
  1. P0 - 玩家角色选择
  2. P0 - 主持人识别玩家发言
  3. P0 - 玩家发言输入与处理
  4. P0 - AI玩家获取人类玩家发言
  5. P0 - 玩家夜间行动交互
  6. P0 - 玩家遗言发表
  7. P0 - 玩家投票交互
  8. P1 - 玩家被淘汰后的观战模式
- **交付顺序**：按优先级顺序依次交付，确保玩家能先选择角色并参与基本互动，再完善其他交互功能
